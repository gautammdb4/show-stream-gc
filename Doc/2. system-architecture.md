# ShowStream - System Architecture Documentation

## ğŸ—ï¸ Architecture Overview

ShowStream is built using a **microservices architecture** with **event-driven communication** to achieve high scalability, reliability, and maintainability. The system is designed to handle 100,000+ concurrent users with sub-3-second response times.

## ğŸ¯ Architecture Principles

### Design Principles
- **Single Responsibility:** Each microservice handles one business domain
- **Database Per Service:** Each service owns its data and database
- **API-First Design:** All services expose well-defined REST APIs
- **Event-Driven Communication:** Asynchronous messaging for loose coupling
- **Fault Tolerance:** Circuit breakers, retries, and graceful degradation
- **Observability:** Comprehensive logging, monitoring, and tracing

### Non-Functional Requirements
- **Performance:** <3 seconds end-to-end booking time
- **Scalability:** Support 100K+ concurrent users
- **Availability:** 99.9% uptime with automatic failover
- **Consistency:** Eventual consistency with strong consistency where needed
- **Security:** JWT-based authentication with role-based authorization

## ğŸ¬ High-Level Architecture

```
                    [Load Balancer]
                           |
                    [API Gateway]
                           |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |          Microservices              |
        | â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”|
        | â”‚User Mgmtâ”‚ â”‚Event Cat.â”‚ â”‚Inventoryâ”‚â”‚
        | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜|
        | â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”|
        | â”‚ Booking â”‚ â”‚ Payment  â”‚ â”‚Notify  â”‚â”‚
        | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜|
        | â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        |
        | â”‚Analyticsâ”‚                        |
        | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        |
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           |
                    [Kafka Cluster]
                           |
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        |          Data Layer                 |
        | â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”|
        | â”‚PostgreSQLâ”‚ â”‚  Redis   â”‚ â”‚ElasticSâ”‚â”‚
        | â”‚(Primary) â”‚ â”‚(Caching) â”‚ â”‚(Search)â”‚â”‚
        | â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜|
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Microservices Detailed Design

### 1. User Management Service

**Responsibility:** User registration, authentication, profile management, and authorization

**Key Components:**
- User Registration and Login
- JWT Token Management
- Profile and Preferences
- Social Login Integration
- Loyalty Program Management

**Database Schema:**
```sql
-- Users table
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    phone VARCHAR(20),
    date_of_birth DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT true
);

-- User preferences
CREATE TABLE user_preferences (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    preferred_language VARCHAR(10),
    preferred_city VARCHAR(100),
    notification_preferences JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Social logins
CREATE TABLE social_logins (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    provider VARCHAR(50),
    provider_user_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**
- `POST /api/users/register` - User registration
- `POST /api/users/login` - User authentication
- `GET /api/users/profile` - Get user profile
- `PUT /api/users/profile` - Update user profile
- `POST /api/users/refresh-token` - Refresh JWT token

**Performance Targets:**
- Registration: <500ms response time
- Authentication: <200ms response time
- Concurrent logins: 10,000+ per minute

### 2. Event Catalog Service

**Responsibility:** Movie/event management, venue information, show timings, and search functionality

**Key Components:**
- Event/Movie Management
- Venue and Theater Information
- Show Scheduling
- Pricing Configuration
- Search and Filtering

**Database Schema:**
```sql
-- Events (Movies, Concerts, etc.)
CREATE TABLE events (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(50),
    genre VARCHAR(100),
    duration_minutes INTEGER,
    rating VARCHAR(10),
    language VARCHAR(50),
    release_date DATE,
    poster_url VARCHAR(500),
    trailer_url VARCHAR(500),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Venues and theaters
CREATE TABLE venues (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address TEXT,
    city VARCHAR(100),
    state VARCHAR(100),
    postal_code VARCHAR(20),
    phone VARCHAR(20),
    total_capacity INTEGER,
    facilities JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Screens/halls within venues
CREATE TABLE screens (
    id BIGSERIAL PRIMARY KEY,
    venue_id BIGINT REFERENCES venues(id),
    name VARCHAR(100),
    capacity INTEGER,
    screen_type VARCHAR(50),
    sound_system VARCHAR(50),
    seating_layout JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Shows/screenings
CREATE TABLE shows (
    id BIGSERIAL PRIMARY KEY,
    event_id BIGINT REFERENCES events(id),
    screen_id BIGINT REFERENCES screens(id),
    show_date DATE,
    show_time TIME,
    base_price DECIMAL(10,2),
    dynamic_pricing_enabled BOOLEAN DEFAULT false,
    total_seats INTEGER,
    available_seats INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**
- `GET /api/events` - List events with filtering
- `GET /api/events/{id}` - Get event details
- `GET /api/events/{id}/shows` - Get shows for an event
- `GET /api/venues` - List venues
- `GET /api/shows/{id}/seats` - Get seat layout

**Performance Targets:**
- Event search: <300ms response time
- Show listing: <200ms response time
- Seat availability: <100ms response time

### 3. Inventory Management Service

**Responsibility:** Real-time seat availability, seat locking, inventory consistency

**Key Components:**
- Seat Availability Tracking
- Distributed Seat Locking
- Inventory Synchronization
- Capacity Management
- Real-time Updates

**Database Schema:**
```sql
-- Seat inventory
CREATE TABLE seat_inventory (
    id BIGSERIAL PRIMARY KEY,
    show_id BIGINT NOT NULL,
    seat_number VARCHAR(10),
    seat_type VARCHAR(20),
    price DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'AVAILABLE',
    locked_until TIMESTAMP,
    locked_by VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Seat locks for booking process
CREATE TABLE seat_locks (
    id BIGSERIAL PRIMARY KEY,
    show_id BIGINT NOT NULL,
    seat_numbers TEXT[], -- Array of seat numbers
    user_id BIGINT,
    session_id VARCHAR(255),
    locked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,
    status VARCHAR(20) DEFAULT 'ACTIVE'
);

-- Inventory snapshots for analytics
CREATE TABLE inventory_snapshots (
    id BIGSERIAL PRIMARY KEY,
    show_id BIGINT,
    snapshot_time TIMESTAMP,
    total_seats INTEGER,
    available_seats INTEGER,
    locked_seats INTEGER,
    booked_seats INTEGER
);
```

**API Endpoints:**
- `GET /api/inventory/shows/{showId}/seats` - Get seat availability
- `POST /api/inventory/lock` - Lock seats for booking
- `PUT /api/inventory/release` - Release seat locks
- `GET /api/inventory/shows/{showId}/summary` - Get inventory summary

**Performance Targets:**
- Seat locking: <100ms response time
- Availability check: <50ms response time
- Concurrent lock requests: 50,000+ per minute

### 4. Booking Engine Service

**Responsibility:** Booking processing, transaction management, booking confirmation

**Key Components:**
- Booking Transaction Processing
- Payment Integration
- Booking Confirmation
- Order Management
- Refund Processing

**Database Schema:**
```sql
-- Bookings
CREATE TABLE bookings (
    id BIGSERIAL PRIMARY KEY,
    booking_reference VARCHAR(20) UNIQUE,
    user_id BIGINT NOT NULL,
    show_id BIGINT NOT NULL,
    booking_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(10,2),
    booking_fee DECIMAL(10,2),
    taxes DECIMAL(10,2),
    final_amount DECIMAL(10,2),
    status VARCHAR(20) DEFAULT 'PENDING',
    payment_status VARCHAR(20) DEFAULT 'PENDING',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Booked seats
CREATE TABLE booking_seats (
    id BIGSERIAL PRIMARY KEY,
    booking_id BIGINT REFERENCES bookings(id),
    seat_number VARCHAR(10),
    seat_type VARCHAR(20),
    price DECIMAL(10,2)
);

-- Booking history and status tracking
CREATE TABLE booking_status_history (
    id BIGSERIAL PRIMARY KEY,
    booking_id BIGINT REFERENCES bookings(id),
    status VARCHAR(20),
    status_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    notes TEXT
);
```

**API Endpoints:**
- `POST /api/bookings` - Create new booking
- `GET /api/bookings/{id}` - Get booking details
- `PUT /api/bookings/{id}/confirm` - Confirm booking after payment
- `PUT /api/bookings/{id}/cancel` - Cancel booking
- `GET /api/bookings/user/{userId}` - Get user's bookings

**Performance Targets:**
- Booking creation: <1 second response time
- Booking confirmation: <500ms response time
- Concurrent bookings: 5,000+ per minute

### 5. Payment Processing Service

**Responsibility:** Payment gateway integration, transaction processing, refund management

**Key Components:**
- Multiple Payment Gateway Integration
- Payment Transaction Management
- Refund and Cancellation Processing
- Payment Status Tracking
- Fraud Detection

**Database Schema:**
```sql
-- Payment transactions
CREATE TABLE payment_transactions (
    id BIGSERIAL PRIMARY KEY,
    transaction_id VARCHAR(100) UNIQUE,
    booking_id BIGINT,
    payment_gateway VARCHAR(50),
    gateway_transaction_id VARCHAR(255),
    amount DECIMAL(10,2),
    currency VARCHAR(3) DEFAULT 'INR',
    status VARCHAR(20) DEFAULT 'INITIATED',
    payment_method VARCHAR(50),
    gateway_response JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Refund transactions
CREATE TABLE refund_transactions (
    id BIGSERIAL PRIMARY KEY,
    original_transaction_id BIGINT REFERENCES payment_transactions(id),
    refund_id VARCHAR(100) UNIQUE,
    refund_amount DECIMAL(10,2),
    refund_status VARCHAR(20),
    refund_reason TEXT,
    gateway_refund_id VARCHAR(255),
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**
- `POST /api/payments/initiate` - Initiate payment
- `POST /api/payments/confirm` - Confirm payment
- `GET /api/payments/{transactionId}` - Get payment status
- `POST /api/payments/refund` - Process refund
- `GET /api/payments/booking/{bookingId}` - Get payment history

### 6. Notification Service

**Responsibility:** Multi-channel notifications, real-time updates, marketing communications

**Key Components:**
- Email Notifications
- SMS Gateway Integration
- Push Notifications
- WhatsApp Business API
- Real-time WebSocket Updates

**Database Schema:**
```sql
-- Notification templates
CREATE TABLE notification_templates (
    id BIGSERIAL PRIMARY KEY,
    template_name VARCHAR(100) UNIQUE,
    template_type VARCHAR(50),
    channel VARCHAR(20),
    subject VARCHAR(255),
    template_content TEXT,
    variables JSONB,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Notification queue
CREATE TABLE notification_queue (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    template_id BIGINT REFERENCES notification_templates(id),
    channel VARCHAR(20),
    recipient_contact VARCHAR(255),
    message_content TEXT,
    variables JSONB,
    status VARCHAR(20) DEFAULT 'QUEUED',
    scheduled_at TIMESTAMP,
    sent_at TIMESTAMP,
    delivery_status VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**
- `POST /api/notifications/send` - Send notification
- `POST /api/notifications/bulk` - Send bulk notifications
- `GET /api/notifications/user/{userId}` - Get user notifications
- `PUT /api/notifications/{id}/read` - Mark as read

### 7. Analytics Service

**Responsibility:** Real-time analytics, reporting, performance monitoring, business intelligence

**Key Components:**
- Real-time Metrics Collection
- Business Analytics Dashboard
- Performance Monitoring
- User Behavior Analytics
- Revenue Analytics

**Database Schema:**
```sql
-- Real-time metrics
CREATE TABLE real_time_metrics (
    id BIGSERIAL PRIMARY KEY,
    metric_name VARCHAR(100),
    metric_value DECIMAL(15,2),
    metric_type VARCHAR(50),
    dimensions JSONB,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- User analytics events
CREATE TABLE user_analytics_events (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT,
    session_id VARCHAR(255),
    event_type VARCHAR(50),
    event_data JSONB,
    page_url VARCHAR(500),
    user_agent TEXT,
    ip_address INET,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Revenue analytics
CREATE TABLE revenue_analytics (
    id BIGSERIAL PRIMARY KEY,
    date DATE,
    total_bookings INTEGER,
    total_revenue DECIMAL(15,2),
    average_ticket_price DECIMAL(10,2),
    total_users INTEGER,
    new_users INTEGER,
    metrics JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**
- `GET /api/analytics/dashboard` - Get dashboard metrics
- `GET /api/analytics/revenue` - Get revenue analytics
- `GET /api/analytics/users` - Get user analytics
- `POST /api/analytics/events` - Track user events

## ğŸ”„ Event-Driven Architecture

### Kafka Topics Design

```yaml
# Core business events
Topics:
  user-events:
    partitions: 6
    retention: 7 days
    use_case: User registration, login, profile updates
    
  inventory-events:
    partitions: 12
    retention: 30 days
    use_case: Seat locks, releases, availability updates
    
  booking-events:
    partitions: 8
    retention: 365 days
    use_case: Booking creation, confirmation, cancellation
    
  payment-events:
    partitions: 6
    retention: 365 days
    use_case: Payment initiation, success, failure, refunds
    
  notification-events:
    partitions: 4
    retention: 7 days
    use_case: Email, SMS, push notification requests
    
  analytics-events:
    partitions: 3
    retention: 90 days
    use_case: User behavior, performance metrics, business events
```

### Event Flow Examples

**Booking Flow Events:**
1. `inventory-events`: Seat lock requested
2. `booking-events`: Booking created (PENDING)
3. `payment-events`: Payment initiated
4. `payment-events`: Payment confirmed
5. `booking-events`: Booking confirmed
6. `inventory-events`: Seats officially booked
7. `notification-events`: Confirmation email/SMS sent
8. `analytics-events`: Booking success metrics recorded

## ğŸ’¾ Data Management Strategy

### Database Design Philosophy
- **Polyglot Persistence:** Right database for the right use case
- **Service Data Ownership:** Each service owns its data completely
- **Event Sourcing:** Critical events stored for replay and audit
- **CQRS:** Separate read and write models for performance

### Database Allocation
```yaml
PostgreSQL (Primary):
  - User Management Service
  - Event Catalog Service
  - Booking Engine Service
  - Payment Processing Service
  
Redis (Caching & Sessions):
  - Session management
  - Seat lock caching
  - Frequently accessed data
  - Rate limiting data
  
Elasticsearch (Search):
  - Event search and filtering
  - Full-text search capabilities
  - Analytics and reporting queries
  - Log aggregation and analysis
```

## ğŸ” Security Architecture

### Authentication & Authorization
- **JWT Tokens:** Stateless authentication with refresh token rotation
- **Role-Based Access Control:** User, Admin, SuperAdmin roles
- **API Rate Limiting:** Per-user and per-endpoint rate limits
- **Input Validation:** Comprehensive input sanitization and validation

### Data Security
- **Encryption at Rest:** Database encryption for sensitive data
- **Encryption in Transit:** TLS 1.3 for all API communications
- **PII Protection:** Personal data anonymization and encryption
- **Audit Logging:** Comprehensive security event logging

## ğŸ“Š Monitoring & Observability

### Metrics Collection
- **Application Metrics:** Business KPIs, performance metrics
- **Infrastructure Metrics:** CPU, memory, disk, network usage
- **Custom Metrics:** Booking success rate, user engagement
- **SLA Monitoring:** Response time, availability, error rates

### Distributed Tracing
- **Request Tracing:** End-to-end request flow tracking
- **Performance Profiling:** Bottleneck identification
- **Error Tracking:** Exception propagation and root cause analysis
- **Service Dependency Mapping:** Real-time service topology

### Alerting Strategy
```yaml
Critical Alerts (Immediate):
  - Service downtime (>30 seconds)
  - Database connection failures
  - Payment processing failures
  - Booking success rate <90%

Warning Alerts (Within 15 minutes):
  - High response times (>3 seconds)
  - Memory usage >80%
  - Kafka consumer lag >1000 messages
  - Error rate >5%

Info Alerts (Within 1 hour):
  - Unusual traffic patterns
  - New deployment notifications
  - Capacity scaling events
  - Weekly performance reports
```

## ğŸš€ Deployment Architecture

### Container Strategy
```yaml
Docker Images:
  - Base Image: OpenJDK 17 Alpine
  - Multi-stage builds for optimization
  - Security scanning integration
  - Image size optimization (<200MB per service)

Kubernetes Deployment:
  - Namespace per environment
  - Resource quotas and limits
  - Horizontal Pod Autoscaling
  - Rolling updates with zero downtime
```

### Environment Strategy
```yaml
Development:
  - Local Docker Compose setup
  - In-memory databases for testing
  - Mock external services
  - Hot reload for development

Staging:
  - Full Kubernetes deployment
  - Production-like data volumes
  - Performance testing environment
  - Integration testing automation

Production:
  - Multi-region deployment
  - Auto-scaling configuration
  - Disaster recovery setup
  - Comprehensive monitoring
```

## ğŸ“ˆ Performance & Scalability

### Performance Targets
- **API Response Time:** <200ms for 95% of requests
- **Booking Completion:** <3 seconds end-to-end
- **Concurrent Users:** 100,000+ simultaneous users
- **Throughput:** 10,000+ bookings per minute
- **Availability:** 99.9% uptime (8.76 hours downtime/year)

### Scalability Strategy
- **Horizontal Scaling:** Auto-scaling based on CPU/memory/custom metrics
- **Database Scaling:** Read replicas for read-heavy operations
- **Caching Strategy:** Multi-level caching (Application, Redis, CDN)
- **Load Balancing:** Intelligent load balancing with health checks

---

*This system architecture provides a solid foundation for building a production-ready, scalable entertainment booking platform that can compete with industry leaders while showcasing advanced microservices design patterns.*